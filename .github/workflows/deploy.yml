name: Deploy ShopFast

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read
  packages: write

env:
  ACR_NAME: shopfastacradd07a1f
  ACR_LOGIN: shopfastacradd07a1f.azurecr.io
  IMAGE_NAME: shopfast
  STG_APP: shopfast-staging
  STG_RG: shopfast-stg-rg
  PRD_APP: shopfast-production
  PRD_RG: shopfast-prd-rg

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Login
        run: az acr login -n $ACR_NAME

      - name: Build & Push Image
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          docker build -t $ACR_LOGIN/$IMAGE_NAME:$TAG -t $ACR_LOGIN/$IMAGE_NAME:latest .
          docker push $ACR_LOGIN/$IMAGE_NAME:$TAG
          docker push $ACR_LOGIN/$IMAGE_NAME:latest

      - name: Deploy to Staging
        run: |
          echo "üöÄ Deploying $IMAGE_TAG to staging..."
          az containerapp update \
            -n $STG_APP -g $STG_RG \
            --image $ACR_LOGIN/$IMAGE_NAME:$IMAGE_TAG

      - name: Smoke Test Staging
        run: |
          echo "üß™ Testing staging..."
          sleep 20
          for i in 1 2 3 4 5; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://$STG_APP.nicepebble-47c13b67.eastus2.azurecontainerapps.io/api/health")
            if [[ "$CODE" == "200" ]]; then
              echo "‚úÖ Staging healthy"
              exit 0
            fi
            echo "  Attempt $i: HTTP $CODE ‚Äî retrying..."
            sleep 10
          done
          echo "‚ùå Staging failed"
          exit 1

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying $IMAGE_TAG to production..."
          az containerapp update \
            -n $PRD_APP -g $PRD_RG \
            --image $ACR_LOGIN/$IMAGE_NAME:$IMAGE_TAG

      - name: Verify Production
        run: |
          echo "üè• Verifying production..."
          sleep 20
          for i in 1 2 3 4 5; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://$PRD_APP.nicepebble-47c13b67.eastus2.azurecontainerapps.io/api/health")
            if [[ "$CODE" == "200" ]]; then
              echo "‚úÖ Production healthy!"
              exit 0
            fi
            echo "  Attempt $i: HTTP $CODE ‚Äî retrying..."
            sleep 10
          done
          echo "‚ùå Production health check failed!"
          exit 1
