name: Deploy ShopFast

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            api/package-lock.json

      - name: Install & build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Copy frontend build to API
        run: |
          rm -rf api/public
          cp -r frontend/dist api/public

      - name: Install API dependencies
        working-directory: api
        run: npm ci --production

      - name: Package application
        run: |
          cd api
          zip -r ../shopfast-deploy.zip . -x "*.git*"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ---- Stage 1: Deploy to Staging Environment ----
      - name: Deploy to Staging
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.STAGING_APP_NAME }}
          resource-group-name: ${{ vars.STAGING_RG }}
          package: shopfast-deploy.zip

      - name: Smoke test ‚Äî Staging
        run: |
          echo "üß™ Testing staging environment..."
          sleep 15
          for i in 1 2 3 4 5; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${{ vars.STAGING_APP_NAME }}.azurewebsites.net/api/health")
            if [[ "$CODE" == "200" ]]; then
              echo "‚úÖ Staging health check passed"
              exit 0
            fi
            echo "  Attempt $i: HTTP $CODE ‚Äî retrying..."
            sleep 10
          done
          echo "‚ùå Staging health check failed"
          exit 1

      # ---- Stage 2: Deploy to Production Staging Slot ----
      - name: Deploy to Production (staging slot)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.PROD_APP_NAME }}
          resource-group-name: ${{ vars.PROD_RG }}
          slot-name: staging
          package: shopfast-deploy.zip

      - name: Smoke test ‚Äî Production Staging Slot
        run: |
          echo "üß™ Testing production staging slot..."
          sleep 15
          for i in 1 2 3 4 5; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${{ vars.PROD_APP_NAME }}-staging.azurewebsites.net/api/health")
            if [[ "$CODE" == "200" ]]; then
              echo "‚úÖ Production slot health check passed"
              exit 0
            fi
            echo "  Attempt $i: HTTP $CODE ‚Äî retrying..."
            sleep 10
          done
          echo "‚ùå Production slot health check failed"
          exit 1

      # ---- Stage 3: Swap to Production ----
      - name: Swap staging slot to production
        run: |
          echo "üîÑ Swapping staging slot to production..."
          az webapp deployment slot swap \
            --name ${{ vars.PROD_APP_NAME }} \
            --resource-group ${{ vars.PROD_RG }} \
            --slot staging \
            --target-slot production

      - name: Post-deploy health check ‚Äî Production
        run: |
          echo "üè• Final production health check..."
          sleep 15
          for i in 1 2 3 4 5; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${{ vars.PROD_APP_NAME }}.azurewebsites.net/api/health")
            if [[ "$CODE" == "200" ]]; then
              echo "‚úÖ Production is live and healthy!"
              exit 0
            fi
            echo "  Attempt $i: HTTP $CODE ‚Äî retrying..."
            sleep 10
          done
          echo "‚ùå Production health check failed after swap!"
          exit 1
